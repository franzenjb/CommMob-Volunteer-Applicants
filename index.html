<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommMob Data Processor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🏥 CommMob Data Processor</h1>
            <p>Process and merge volunteer/applicant data for ArcGIS feature layers</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Master Applicants:</span>
                <span id="master-applicants-count" class="status-value">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Master Volunteers:</span>
                <span id="master-volunteers-count" class="status-value">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">New Applicants:</span>
                <span id="new-applicants-count" class="status-value">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">New Volunteers:</span>
                <span id="new-volunteers-count" class="status-value">-</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Clean Instructions Section -->
            <div class="instructions-section">
                <div class="instructions-header">
                    <h2>📋 Before You Start</h2>
                    <p>Follow these steps to prepare your data files:</p>
                </div>
                
                <div class="steps-container">
                    <div class="step-card">
                        <div class="step-icon">🧹</div>
                        <h3>Clean Your Files</h3>
                        <p>Remove metadata rows (1-8) from Volunteer Connection exports. Keep only actual headers and data.</p>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-icon">🌍</div>
                        <h3>Geocode with Geocodio</h3>
                        <p>Visit <a href="https://www.geocod.io/" target="_blank">Geocodio.com</a> to add coordinates and standardize addresses.</p>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-icon">📁</div>
                        <h3>Upload Processed Files</h3>
                        <p>Use files with <code>_geocodio</code> suffix for best results.</p>
                    </div>
                </div>
                
                <div class="help-link">
                    <button id="show-detailed-help" class="help-button">Need detailed instructions?</button>
                </div>
            </div>

            <div class="upload-section">
                <h2>📁 Upload Data Files</h2>
                <div class="upload-areas">
                    <div class="upload-area" id="applicants-upload">
                        <div class="upload-content">
                            <div class="upload-icon">📄</div>
                            <h3>Applicants Data</h3>
                            <p>Drag & drop or click to select</p>
                            <input type="file" id="applicants-file" accept=".csv" hidden>
                        </div>
                        <div class="file-info" id="applicants-file-info"></div>
                    </div>
                    <div class="upload-area" id="volunteers-upload">
                        <div class="upload-content">
                            <div class="upload-icon">👥</div>
                            <h3>Volunteers Data</h3>
                            <p>Drag & drop or click to select</p>
                            <input type="file" id="volunteers-file" accept=".csv" hidden>
                        </div>
                        <div class="file-info" id="volunteers-file-info"></div>
                    </div>
                </div>
            </div>

            <div class="processing-section">
                <h2>⚙️ Processing Options</h2>
                <div class="processing-options">
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="skip-header-rows" checked>
                            Skip header rows (recommended for NEIA files)
                        </label>
                    </div>
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="validate-data" checked>
                            Validate data structure before processing
                        </label>
                    </div>
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="backup-files" checked>
                            Create backup of master files
                        </label>
                    </div>
                </div>
                <button id="process-btn" class="process-btn" disabled>🔄 Process Data</button>
            </div>

            <div class="results-section" id="results-section" style="display: none;">
                <h2>📊 Processing Results</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <h3>Before Processing</h3>
                        <div class="count-display">
                            <div class="count-item">
                                <span class="count-label">Master Applicants:</span>
                                <span id="before-applicants-count" class="count-value">-</span>
                            </div>
                            <div class="count-item">
                                <span class="count-label">Master Volunteers:</span>
                                <span id="before-volunteers-count" class="count-value">-</span>
                            </div>
                            <div class="count-item">
                                <span class="count-label">New Applicants:</span>
                                <span id="before-new-applicants-count" class="count-value">-</span>
                            </div>
                            <div class="count-item">
                                <span class="count-label">New Volunteers:</span>
                                <span id="before-new-volunteers-count" class="count-value">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>After Processing</h3>
                        <div class="count-display">
                            <div class="count-item">
                                <span class="count-label">Updated Applicants:</span>
                                <span id="after-applicants-count" class="count-value">-</span>
                            </div>
                            <div class="count-item">
                                <span class="count-label">Updated Volunteers:</span>
                                <span id="after-volunteers-count" class="count-value">-</span>
                            </div>
                            <div class="count-item">
                                <span class="count-label">Validation Status:</span>
                                <span id="validation-status" class="count-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="download-section">
                    <h3>📥 Download Processed Files</h3>
                    <div class="download-buttons">
                        <button id="download-applicants" class="download-btn" disabled>
                            📄 Download Applicants 2025.csv
                        </button>
                        <button id="download-volunteers" class="download-btn" disabled>
                            👥 Download Volunteer 2025.csv
                        </button>
                        <button id="download-report" class="download-btn report-btn" disabled>
                            📋 Download Processing Report
                        </button>
                    </div>
                </div>

                <div class="version-management-section">
                    <h3>🗂️ Database Version Management</h3>
                    <div class="version-controls">
                        <button id="show-version-history" class="version-btn">
                            📋 View Version History
                        </button>
                        <button id="create-manual-backup" class="version-btn">
                            💾 Create Manual Backup
                        </button>
                    </div>
                    <div id="version-history" class="version-history" style="display: none;">
                        <h4>📚 Version History</h4>
                        <div id="version-list" class="version-list">
                            <!-- Version items will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>📊 Processing Report Summary</h3>
                    <div id="report-summary" class="report-summary"></div>
                </div>

                <div class="preview-section">
                    <h3>👀 Preview Data</h3>
                    <div class="preview-tabs">
                        <button class="tab-btn active" data-tab="applicants-preview">Applicants</button>
                        <button class="tab-btn" data-tab="volunteers-preview">Volunteers</button>
                    </div>
                    <div class="preview-content">
                        <div id="applicants-preview" class="preview-tab-content active">
                            <div class="preview-table-container">
                                <table id="applicants-preview-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="volunteers-preview" class="preview-tab-content">
                            <div class="preview-table-container">
                                <table id="volunteers-preview-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-section">
            <h3>📝 Processing Log</h3>
            <div id="log-content" class="log-content"></div>
        </div>
        
        <!-- Important Next Steps Reminder -->
        <div style="margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #9ca3af;">
            <h4 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px; font-weight: 600;">📝 Next Steps After Download (Personal Reminder)</h4>
            <ol style="margin: 0; padding-left: 20px; color: #9ca3af; font-size: 13px; line-height: 1.8;">
                <li>Download the processed files to the <strong>FINAL CSV</strong> folder under applicants CSV:
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>Volunteer 2025.csv</li>
                        <li>Applicants 2025.csv</li>
                    </ul>
                </li>
                <li>Update the feature layers found in the <strong>CM Volunteer Map</strong> (shown in gray/light on the map)</li>
            </ol>
        </div>
    </div>

    <!-- Detailed Instructions Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 Detailed Instructions</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="instruction-step">
                    <h3>Step 1: Clean Your Files</h3>
                    <p>Open your Volunteer Connection export files and delete rows 1-8 that contain metadata. Keep ONLY row 9 (actual headers) and move it to row 1.</p>
                    <div class="step-details">
                        <strong>Delete these rows:</strong>
                        <ul>
                            <li>"American Red Cross - Created by Volunteer Connection"</li>
                            <li>"Data from last night: [date]"</li>
                            <li>"Applicant Listing - Applications between [dates]"</li>
                            <li>"Region: [Your Region Name]"</li>
                            <li>Various description rows</li>
                        </ul>
                    </div>
                </div>
                
                <div class="instruction-step">
                    <h3>Step 2: Geocode with Geocodio</h3>
                    <p>Visit <a href="https://www.geocod.io/" target="_blank">Geocodio.com</a> and geocode your cleaned CSV file.</p>
                    <div class="step-details">
                        <strong>Benefits:</strong>
                        <ul>
                            <li>Proper capitalization (Atlanta, GA instead of ATLANTA, GA)</li>
                            <li>Standardized formatting</li>
                            <li>Accurate coordinates</li>
                            <li>Better chapter assignment</li>
                        </ul>
                        <strong>Steps:</strong>
                        <ol>
                            <li>Upload your cleaned CSV file</li>
                            <li>Select address columns (Address, City, State, Zip)</li>
                            <li>Run the geocoding process</li>
                            <li>Download results (will have <code>_geocodio</code> suffix)</li>
                            <li>Verify coordinates and formatted addresses</li>
                        </ol>
                    </div>
                </div>
                
                <div class="instruction-step">
                    <h3>Step 3: Upload Processed Files</h3>
                    <p>Only upload files with <code>_geocodio</code> suffix. Do NOT upload raw Volunteer Connection files.</p>
                    <div class="step-details">
                        <strong>Correct file names:</strong>
                        <ul>
                            <li><code>YourRegion Applicants 9 25_geocodio.csv</code> ✅</li>
                            <li><code>YourRegion Volunteers 9 25_geocodio.csv</code> ✅</li>
                        </ul>
                        <strong>Wrong file names:</strong>
                        <ul>
                            <li><code>YourRegion Applicants 9 25.csv</code> ❌</li>
                            <li><code>YourRegion Volunteers 9 25.csv</code> ❌</li>
                        </ul>
                    </div>
                </div>
                
                <div class="instruction-step">
                    <h3>Step 4: Update ArcGIS Feature Layers</h3>
                    <p>After downloading the processed files, update the CM Volunteer Map feature layers.</p>
                    <div class="step-details">
                        <strong>Important:</strong>
                        <ul>
                            <li>Find the <strong>CM Volunteer Map</strong> in ArcGIS</li>
                            <li>Update both feature layers (shown in gray/light on the map)</li>
                            <li>Save downloaded files to <strong>FINAL CSV</strong> folder</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 12px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <strong style="color: #b91c1c;">⚠️ CRITICAL:</strong> These files MUST update the master files in this application!
                            <ul style="margin-top: 8px; margin-bottom: 0;">
                                <li>Replace the old master files with your downloaded files</li>
                                <li>Commit and push to GitHub to save permanently</li>
                                <li>Next time you load the app, totals will show the increased counts</li>
                                <li>This ensures continuous data accumulation, not replacement</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <!-- Version: 1.2 - Clean UI/UX with modal instructions -->
</body>
</html>
